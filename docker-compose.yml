version: '3.8'

services:
  clickhouse:
    image: clickhouse/clickhouse-server:24.3.3.102-alpine
    container_name: mida-clickhouse
    hostname: clickhouse
    restart: unless-stopped
    ports:
      - "30900:8123"    # HTTP interface (web UI)
      - "30123:9000"    # Native TCP interface
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: root
      CLICKHOUSE_PASSWORD: hoangnx1
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
      - ./clickhouse-config:/etc/clickhouse-server/config.d
      - ./clickhouse-users:/etc/clickhouse-server/users.d
    networks:
      - mida-storage
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 30s
      timeout: 5s
      retries: 3

  minio:
    image: bitnami/minio:2023.2.10-debian-11-r1
    container_name: mida-minio
    hostname: minio
    restart: unless-stopped
    ports:
      - "30000:9001"    # MinIO Console (Web UI)
      - "9000:9000"     # MinIO API
    environment:
      MINIO_ROOT_USER: minio-admin
      MINIO_ROOT_PASSWORD: minio-secret-key-2024
      MINIO_DEFAULT_BUCKETS: midareplay-storage
      MINIO_BROWSER: "on"
      BITNAMI_DEBUG: "false"
      MINIO_FORCE_NEW_KEYS: "no"
    volumes:
      - minio_data:/data
    networks:
      - mida-storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    command: >
      sh -c "
      mkdir -p /data/midareplay-storage &&
      minio server /data --console-address ':9001'
      "

volumes:
  clickhouse_data:
    driver: local
  clickhouse_logs:
    driver: local
  minio_data:
    driver: local

networks:
  mida-storage:
    driver: bridge
    name: mida-storage
